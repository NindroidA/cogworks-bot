name: Discord Changelog Update

on:
  push:
    branches: [main]
    paths:
      - 'CHANGELOG.md'

jobs:
  send-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract and format changelog
        id: changelog
        run: |
          # Extract version from first changelog entry (## [X.Y.Z] - date)
          VERSION=$(grep -oE '## \[[0-9]+\.[0-9]+\.[0-9]+\]' CHANGELOG.md | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          VERSION="v${VERSION:-Latest}"

          # Extract the first changelog section (between first and second ## [version])
          CHANGELOG=$(awk '
            BEGIN { found=0; in_section=0 }

            # Match version headers: ## [X.Y.Z] - YYYY-MM-DD
            /^## \[[0-9]+\.[0-9]+\.[0-9]+\]/ {
              if (found) exit;
              found=1;
              next;
            }

            # Capture section headers (### Added, ### Fixed, etc.)
            found && /^### / {
              in_section=1;
              print;
              next;
            }

            # Print content within sections
            found && in_section { print }

          ' CHANGELOG.md)

          # Random subheader quotes â€” add new lines to scale
          QUOTES=(
            "Yippee! New working cogs!"
            "Fresh gears, who dis?"
            "My cogs have been oiled!"
            "Beep boop"
            "Another day, another cog in the machine"
            "SPINNY COGS!"
            "Turning the wheels of progress"
            "Let's get spinning!"
            "Squeaky clean ;)"
            "Vibing with better cogs!"
            "Oops, I did it again"
            "Oops All Cogs!"
            "Whoops, you found the secret cog stash!"
            "I stole more cogs from the factory"
            "EXPLOSION OF COGS! (Don't worry, they're all new and shiny)"
            "Another one"
            "Cog go brrrrrrr"
            "Cog in the works?"
          )
          QUOTE="${QUOTES[$((RANDOM % ${#QUOTES[@]}))]}"

          # Build the formatted message
          REPO_URL="https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"

          HEADER="# Cogworks Bot ${VERSION}"
          SUBHEADER="> ${QUOTE}"
          FOOTER="-# [View full changelog](${REPO_URL})"

          MESSAGE=$(printf '%s\n\n%s\n\n%s\n\n%s' "$HEADER" "$SUBHEADER" "$CHANGELOG" "$FOOTER")

          # Truncate if too long (Discord limit - 2000 chars)
          if [ ${#MESSAGE} -gt 1950 ]; then
            TRUNCATED="${MESSAGE:0:1850}"
            # Remove the last line to avoid partial items
            TRUNCATED=$(echo "$TRUNCATED" | head -n -1)
            MESSAGE=$(printf '%s\n\n...\n\n%s' "$TRUNCATED" "$FOOTER")
          fi

          # Set outputs using heredoc for multiline content
          {
            echo "version=$VERSION"
            echo "content<<CHANGELOG_EOF"
            echo "$MESSAGE"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          CHANGELOG_CONTENT: ${{ steps.changelog.outputs.content }}
        run: |
          # Create JSON payload using jq with proper escaping
          # Suppress embeds by using flags: 4 = SUPPRESS_EMBEDS
          jq -n --arg content "${CHANGELOG_CONTENT}" '{content: $content, flags: 4}' > payload.json

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
