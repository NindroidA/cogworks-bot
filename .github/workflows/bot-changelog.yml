name: Discord Changelog Update

on:
  push:
    branches: [main]
    paths:
      - 'CHANGELOG.md'

jobs:
  send-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract and format changelog
        id: changelog
        run: |
          # Extract version from first line
          VERSION=$(head -1 CHANGELOG.md | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' || echo "Latest")

          # Extract the first changelog section (between first and second "# Dev Update")
          # Then format sections
          CHANGELOG=$(awk '
            BEGIN { found=0; in_section=0; current_section="" }

            # Start capturing at first "# Dev Update"
            /^# Dev Update/ {
              if (found) exit;
              found=1;
              next;
            }

            # Skip horizontal rules
            /^---$/ { next }

            # Capture section headers (Added, Fixed, etc.)
            found && /^## / {
              current_section = substr($0, 4);
              in_section=1;
              print "### " current_section;
              next;
            }

            # Print content within sections
            found && in_section { print }

          ' CHANGELOG.md)

          # Build the formatted message
          REPO_URL="https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"

          # Create the full message using printf to handle special characters
          HEADER="# Cogworks Bot ${VERSION}"
          QUOTE="> Yippee! New working cogs!"
          FOOTER="-# [View full changelog](${REPO_URL})"

          MESSAGE=$(printf '%s\n\n%s\n\n%s\n---\n%s' "$HEADER" "$QUOTE" "$CHANGELOG" "$FOOTER")

          # Truncate if too long (Discord limit is 2000 chars)
          if [ ${#MESSAGE} -gt 1950 ]; then
            TRUNCATED="${MESSAGE:0:1850}"
            # Remove the last line to avoid partial items
            TRUNCATED=$(echo "$TRUNCATED" | head -n -1)
            MESSAGE=$(printf '%s\n\n...\n\n---\n%s' "$TRUNCATED" "$FOOTER")
          fi

          # Set outputs using heredoc for multiline content
          {
            echo "version=$VERSION"
            echo "content<<CHANGELOG_EOF"
            echo "$MESSAGE"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          CHANGELOG_CONTENT: ${{ steps.changelog.outputs.content }}
        run: |
          # Create JSON payload using jq with proper escaping
          # Suppress embeds by using flags: 4 = SUPPRESS_EMBEDS
          jq -n --arg content "${CHANGELOG_CONTENT}" '{content: $content, flags: 4}' > payload.json

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
