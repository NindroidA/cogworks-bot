name: Changelog Update

on:
  push:
    branches: [main] # or your default branch
    paths:
      - 'CHANGELOG.md'

jobs:
  send-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get changelog diff
        id: changelog_diff
        run: |
          # get the latest changes from the changelog
          DIFF=$(git diff HEAD~1 HEAD -- changelog.md || git diff HEAD~1 HEAD -- CHANGELOG.md)
          
          # extract only added lines
          ADDED_LINES=$(echo "$DIFF" | grep "^+" | grep -v "^+++" | sed 's/^+//')
          
          # escape the content for JSON
          ESCAPED_CONTENT=$(echo "$ADDED_LINES" | jq -sR .)
          
          # store in output
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Create the webhook payload
          CONTENT=${{ steps.changelog_diff.outputs.content }}
          
          # Format the message
          MESSAGE=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“‹ Bot Update",
              "description": "New changes have been pushed!",
              "color": 3066993,
              "fields": [{
                "name": "Latest Changes",
                "value": ${CONTENT:0:1000}
              }],
              "footer": {
                "text": "Commit: ${{ github.sha }}"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$MESSAGE" \
               "$DISCORD_WEBHOOK"